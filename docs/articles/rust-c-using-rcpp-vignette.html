<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rusting Faster: Simulation using Rcpp • rust</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/paper/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Rusting Faster: Simulation using Rcpp">
<meta property="og:description" content="rust">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">rust</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.3.12.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/rust-a-vignette.html">Introducing rust: Ratio-of-Uniforms Simulation with Transformation</a>
    </li>
    <li>
      <a href="../articles/rust-b-when-to-use-vignette.html">When can rust be used?</a>
    </li>
    <li>
      <a href="../articles/rust-c-using-rcpp-vignette.html">Rusting Faster: Simulation using Rcpp</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/paulnorthrop/rust/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="rust-c-using-rcpp-vignette_files/header-attrs-2.9/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Rusting Faster: Simulation using Rcpp</h1>
                        <h4 class="author">Paul Northrop</h4>
            
            <h4 class="date">2021-09-12</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/paulnorthrop/rust/blob/master/vignettes/rust-c-using-rcpp-vignette.Rmd"><code>vignettes/rust-c-using-rcpp-vignette.Rmd</code></a></small>
      <div class="hidden name"><code>rust-c-using-rcpp-vignette.Rmd</code></div>

    </div>

    
    
<p>The <strong>rust</strong> package implements the multivariate generalized ratio-of-uniforms method of simulating random variates from a <span class="math inline">\(d\)</span>-dimensional continuous distribution. The user specifies (the log of) a positive target function <span class="math inline">\(f(x)\)</span> proportional to the density function of the distribution. For an introduction to <em>rust</em> see the vignette <a href="rust-a-vignette.html">Introducing rust</a>.</p>
<p>This vignette describes a new feature of <strong>rust</strong>: the option for the user to provide a C++ function to evaluate the target log-density, rather than an R function. The <strong>Rcpp</strong> <span class="citation">Eddelbuettel (2013)</span> and <strong>RcppArmadillo</strong> <span class="citation">(Eddelbuettel and Sanderson 2014)</span> packages are used to speed up simulation from the target density. The improvement results from faster function evaluations and (in particular) from performing using C++ the looping in the ratio-of-uniforms algorithm. The new function <code>ru_rcpp</code> requires the target log-density to be specified using (externals pointers to) C++ functions, whereas the existing <code>ru</code> requires input R functions. Otherwise, the functionality of these two functions is the same. There are also Rcpp-based versions of functions for setting Box-Cox transformation parameters: <code>find_lambda_rcpp</code> and <code>find_lambda_one_d_rcpp</code></p>
<p>In this vignette we describe in general terms the general setup of the Rcpp-based functions and use examples to illustrate their use. For more information about these examples see the vignette <a href="rust-a-vignette.html">Introducing rust</a></p>
<div id="cpp_fun" class="section level2">
<h2 class="hasAnchor">
<a href="#cpp_fun" class="anchor"></a>Providing a C++ function to <code>ru_rcpp</code>
</h2>
<p>The general way that <strong>rust</strong> enables users to provide their own C++ functions uses external pointers and is based on the <a href="https://gallery.rcpp.org/">Rcpp Gallery</a> article <a href="https://gallery.rcpp.org/articles/passing-cpp-function-pointers/">Passing user-supplied C++ functions</a> by Dirk Eddelbuettel. For a detailed case study of the general approach see the <strong>RcppDE</strong> package <span class="citation">(Eddelbuettel 2016)</span> vignette at the <a href="https://CRAN.R-project.org/package=RcppDE">RcppDE page on CRAN</a>.</p>
<p>The user writes a C++ function to calculate <span class="math inline">\(\log f(x)\)</span>. The current implementation in <strong>rust</strong> requires this function to have a particular structure: it must take a constant reference to an <code>Rcpp::NumericVector</code>, say <code>x</code>, a constant reference to an <code>Rcpp::List</code>, say <code>pars</code>, and return a <code>double</code> precision scalar. <code>x</code> is the argument <span class="math inline">\(x\)</span> of <span class="math inline">\(f(x)\)</span>. <code>pars</code> is a list containing the values of parameters whose values are not specified inside the function. This allows the user to change the values of any parameters in the target density without editing the function. If there are no such parameters then the user must still include the argument <code>pars</code> in their function, even though the list provided to the function when it is called will be empty.</p>
<p>A simple way for the user to provide their C++ functions to create them in a file, say <code>user_fns.cpp</code>. Example content is provided below. The full file is available on the <a href="https://github.com/paulnorthrop/rust/blob/master/src/user_fns.cpp">rust Github page</a>. The functions in this file are compiled and made available to R, either using the <code><a href="https://rdrr.io/pkg/Rcpp/man/sourceCpp.html">Rcpp::sourceCpp</a></code> function (e.g. <code><a href="https://rdrr.io/pkg/Rcpp/man/sourceCpp.html">Rcpp::sourceCpp("user_fns.cpp")</a></code>) or using RStudio’s Source button on the editor toolbar. The example content below also includes the function <code>create_xptr</code>, which creates an external pointer to a C++ function. See <a href="https://gallery.rcpp.org/articles/passing-cpp-function-pointers/">Passing user-supplied C++ functions</a>. It is this external pointer that is passed to <code>ru_rcpp</code> to perform ratio-of-uniforms sampling. If the user has written a C++ function, say <code>new_name</code>, then they need to add to <code>create_xptr</code> two lines of code:</p>
<pre><code>else if (fstr == "new_name")  
  return(Rcpp::XPtr&lt;funcPtr&gt;(new funcPtr(&amp;new_name))) ;</code></pre>
<p>to create an external pointer for <code>new_name</code> using <code>create_xptr</code>. The following excerpt from the example <code>user_fns.cpp</code> file contains code for a standard normal density. Note that for this particular example we don’t need RcppArmadillo: we could replace <code>#include &lt;RcppArmadillo.h&gt;</code> with <code>#include &lt;Rcpp.h&gt;</code> and delete <code>using namespace arma;</code>. However, RcppArmadillo is used in the the <a href="#mvn">multivariate normal example</a> below and will be useful in many examples.</p>
<pre><code>// [[Rcpp::depends(RcppArmadillo)]]

#include &lt;RcppArmadillo.h&gt;

using namespace arma;
using namespace Rcpp;

// [[Rcpp::interfaces(r, cpp)]]

// User-supplied C++ functions for logf.

// Note that currently the only interface available in rust is
// double fun(const Rcpp::NumericVector&amp; x, const Rcpp::List&amp; pars).
// However, as shown in the function logdmvnorm below RcppArmadillo
// functions can be used inside the function.

// Each function must be prefaced by the line: // [[Rcpp::export]]

// One-dimensional standard normal.

// [[Rcpp::export]]  
double logdN01(const Rcpp::NumericVector&amp; x, const Rcpp::List&amp; pars) {  
  return (-pow(x[0], 2.0) / 2.0) ;
}

// A function to create external pointers for any of the functions above.  
// See http://gallery.rcpp.org/articles/passing-cpp-function-pointers/  
// If you write a new function above called new_name then add the following
//
// else if (fstr == "new_name")  
//   return(Rcpp::XPtr&lt;funcPtr&gt;(new funcPtr(&amp;new_name))) ;  

// [[Rcpp::export]]  
SEXP create_xptr(std::string fstr) {  
  typedef double (*funcPtr)(const Rcpp::NumericVector&amp; x,  
                  const Rcpp::List&amp; pars) ;  
  if (fstr == "logdN01")  
    return(Rcpp::XPtr&lt;funcPtr&gt;(new funcPtr(&amp;logdN01))) ;  
  else  
    return(Rcpp::XPtr&lt;funcPtr&gt;(R_NilValue)) ;  
}  

// We could create the external pointers when this file is sourced using   
// the embedded R code below and/or (re)create them using create_xptr() in 
// an R session or R package..

/*** R
ptr_N01 &lt;- create_xptr("logdN01")
*/</code></pre>
</div>
<div id="examples-ru_rcpp" class="section level2">
<h2 class="hasAnchor">
<a href="#examples-ru_rcpp" class="anchor"></a>Examples : <code>ru_rcpp</code>
</h2>
<p>All the examples in the documentation for <code>ru</code> are replicated in the documentation for <code>ru_rcpp</code>. Here we consider a subset of the examples from the <a href="rust-a-vignette.html">Introducing rust</a> vignette, to illustrate how to provide user-supplied C++ functions to <code>ru_rcpp</code> and to compare the performances of <code>ru</code> and <code>ru_rcpp</code>. We use the <strong>microbenchmark</strong> package <span class="citation">(Mersmann 2015)</span> to make the comparison.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://paulnorthrop.github.io/rust/">rust</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://www.rcpp.org">Rcpp</a></span><span class="op">)</span>
<span class="co"># Is microbenchmark available?</span>
<span class="va">got_microbenchmark</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ns-load.html">requireNamespace</a></span><span class="op">(</span><span class="st">"microbenchmark"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="kw">if</span> <span class="op">(</span><span class="va">got_microbenchmark</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/joshuaulrich/microbenchmark/">microbenchmark</a></span><span class="op">)</span>
<span class="op">}</span>  
<span class="co"># Set the size of the simulated sample</span>
<span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">1000</span></code></pre></div>
<p>It is assumed that the user has already compiled their C++ functions and made them available to their R session, either using the <code><a href="https://rdrr.io/pkg/Rcpp/man/sourceCpp.html">Rcpp::sourceCpp</a></code> function (e.g. <code><a href="https://rdrr.io/pkg/Rcpp/man/sourceCpp.html">Rcpp::sourceCpp("user_fns.cpp")</a></code>) or using RStudio’s Source button on the editor toolbar.</p>
<div id="standard-normal-density" class="section level3">
<h3 class="hasAnchor">
<a href="#standard-normal-density" class="anchor"></a>Standard normal density</h3>
<p>We start with a simple example: the (1-dimensional) standard normal density, based on the C++ function <code>logdN01</code> in the example <code>user_fns.cpp</code> file above.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Normal density ===================</span>

<span class="co"># Create a pointer to the logdN01 C++ function</span>
<span class="co"># (not necessary if this was created when the file of C++ functions was sourced)</span>
<span class="va">ptr_N01</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_xptr.html">create_xptr</a></span><span class="op">(</span><span class="st">"logdN01"</span><span class="op">)</span>

<span class="co"># Use ru and ru_rcpp starting from the same random number seed and check</span>
<span class="co"># that the simulated values are the same.</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">47</span><span class="op">)</span>
<span class="va">x_old</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ru.html">ru</a></span><span class="op">(</span>logf <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">-</span><span class="va">x</span> <span class="op">^</span> <span class="fl">2</span> <span class="op">/</span> <span class="fl">2</span>, d <span class="op">=</span> <span class="fl">1</span>, n <span class="op">=</span> <span class="va">n</span>, init <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">x_old</span><span class="op">$</span><span class="va">sim_vals</span><span class="op">)</span>
<span class="co">#&gt;            [,1]</span>
<span class="co">#&gt; [1,]  0.7764728</span>
<span class="co">#&gt; [2,]  0.5310434</span>
<span class="co">#&gt; [3,] -0.1046049</span>
<span class="co">#&gt; [4,]  1.2111509</span>
<span class="co">#&gt; [5,]  1.1391379</span>
<span class="co">#&gt; [6,]  0.5180914</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">47</span><span class="op">)</span>
<span class="va">x_new</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ru_rcpp.html">ru_rcpp</a></span><span class="op">(</span>logf <span class="op">=</span> <span class="va">ptr_N01</span>, d <span class="op">=</span> <span class="fl">1</span>, n <span class="op">=</span> <span class="va">n</span>, init <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">x_new</span><span class="op">$</span><span class="va">sim_vals</span><span class="op">)</span>
<span class="co">#&gt;            [,1]</span>
<span class="co">#&gt; [1,]  0.7764728</span>
<span class="co">#&gt; [2,]  0.5310434</span>
<span class="co">#&gt; [3,] -0.1046049</span>
<span class="co">#&gt; [4,]  1.2111509</span>
<span class="co">#&gt; [5,]  1.1391379</span>
<span class="co">#&gt; [6,]  0.5180914</span>

<span class="co"># Compare performances of ru and ru_rcpp</span>
<span class="kw">if</span> <span class="op">(</span><span class="va">got_microbenchmark</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span>
    old <span class="op">=</span> <span class="fu"><a href="../reference/ru.html">ru</a></span><span class="op">(</span>logf <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">-</span><span class="va">x</span> <span class="op">^</span> <span class="fl">2</span> <span class="op">/</span> <span class="fl">2</span>, d <span class="op">=</span> <span class="fl">1</span>, n <span class="op">=</span> <span class="va">n</span>, init <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span>,
    new <span class="op">=</span> <span class="fu"><a href="../reference/ru_rcpp.html">ru_rcpp</a></span><span class="op">(</span>logf <span class="op">=</span> <span class="va">ptr_N01</span>, d <span class="op">=</span> <span class="fl">1</span>, n <span class="op">=</span> <span class="va">n</span>, init <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span>
  <span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">res</span>, signif <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>
<span class="op">}</span>
<span class="co">#&gt; Unit: milliseconds</span>
<span class="co">#&gt;  expr    min     lq  mean median     uq    max neval</span>
<span class="co">#&gt;   old 20.260 21.290 23.25 22.510 24.910 30.190   100</span>
<span class="co">#&gt;   new  1.862  2.047  2.34  2.135  2.259  6.555   100</span></code></pre></div>
<p>As we would hope, <code>ru_rcpp</code> is faster than <code>ru</code>. If we start from the same random number seed we get the same simulated values from <code>ru</code> and <code>ru_rcpp</code>.</p>
</div>
<div id="mvn" class="section level3">
<h3 class="hasAnchor">
<a href="#mvn" class="anchor"></a>Multivariate normal density</h3>
<p>To execute this example we add the following function to <code>user_fns.cpp</code></p>
<pre><code>// d-dimensional normal with zero-mean and covariance matrix sigma.

// [[Rcpp::export]]
double logdmvnorm(const Rcpp::NumericVector&amp; x, const Rcpp::List&amp; pars) {
  arma::mat sigma = as&lt;arma::mat&gt;(pars["sigma"]) ;
  arma::vec y = Rcpp::as&lt;arma::vec&gt;(x) ;
  double qform = arma::as_scalar(y.t() * arma::inv(sigma) * y) ;
  return -qform / 2.0  ;
}</code></pre>
<p>and add</p>
<pre><code>else if (fstr == "logdmvnorm")
  return(Rcpp::XPtr&lt;funcPtr&gt;(new funcPtr(&amp;logdmvnorm))) ;</code></pre>
<p>to the function <code>create_xptr</code> in <code>user_fns.cpp</code>.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Three-dimensional normal with positive association ----------------</span>
<span class="va">rho</span> <span class="op">&lt;-</span> <span class="fl">0.9</span>
<span class="va">covmat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="va">rho</span>, <span class="fl">3</span>, <span class="fl">3</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">rho</span>, <span class="fl">3</span><span class="op">)</span>
<span class="co"># R function</span>
<span class="va">log_dmvnorm</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">mean</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">d</span><span class="op">)</span>, <span class="va">sigma</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="va">x</span>, ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>
  <span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
  <span class="op">-</span> <span class="fl">0.5</span> <span class="op">*</span> <span class="op">(</span><span class="va">x</span> <span class="op">-</span> <span class="va">mean</span><span class="op">)</span> <span class="op">%*%</span> <span class="fu"><a href="https://rdrr.io/r/base/solve.html">solve</a></span><span class="op">(</span><span class="va">sigma</span><span class="op">)</span> <span class="op">%*%</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">x</span> <span class="op">-</span> <span class="va">mean</span><span class="op">)</span>
<span class="op">}</span>
<span class="co"># Create a pointer to the logdmvnorm C++ function</span>
<span class="va">ptr_mvn</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_xptr.html">create_xptr</a></span><span class="op">(</span><span class="st">"logdmvnorm"</span><span class="op">)</span>

<span class="kw">if</span> <span class="op">(</span><span class="va">got_microbenchmark</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span>
    old <span class="op">=</span> <span class="fu"><a href="../reference/ru.html">ru</a></span><span class="op">(</span>logf <span class="op">=</span> <span class="va">log_dmvnorm</span>, sigma <span class="op">=</span> <span class="va">covmat</span>, d <span class="op">=</span> <span class="fl">3</span>, n <span class="op">=</span> <span class="va">n</span>,
             init <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span>, 
    new <span class="op">=</span> <span class="fu"><a href="../reference/ru_rcpp.html">ru_rcpp</a></span><span class="op">(</span>logf <span class="op">=</span> <span class="va">ptr_mvn</span>, sigma <span class="op">=</span> <span class="va">covmat</span>, d <span class="op">=</span> <span class="fl">3</span>, n <span class="op">=</span> <span class="va">n</span>,
                  init <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span>
  <span class="op">)</span>  
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">res</span>, signif <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>
<span class="op">}</span>  
<span class="co">#&gt; Unit: milliseconds</span>
<span class="co">#&gt;  expr     min      lq    mean  median     uq    max neval</span>
<span class="co">#&gt;   old 198.300 209.100 216.400 214.100 221.00 280.70   100</span>
<span class="co">#&gt;   new   7.339   7.775   8.325   8.061   8.29  12.15   100</span></code></pre></div>
<p>Again, the improvement in speed obtained using Rcpp is clear.</p>
</div>
<div id="log-normal-density-after-box-cox-transformation" class="section level3">
<h3 class="hasAnchor">
<a href="#log-normal-density-after-box-cox-transformation" class="anchor"></a>Log-normal density after Box-Cox transformation</h3>
<p>In this example we use a log transform (Box-Cox parameter <span class="math inline">\(\lambda = 0\)</span>) so that the ratio-of-uniforms sampling is based on a normal distribution. The C++ function to calculate the log-density of a lognormal distribution is:</p>
<pre><code>// Lognormal(mu, sigma).

// [[Rcpp::export]]
double logdlnorm(const Rcpp::NumericVector&amp; x, const Rcpp::List&amp; pars) {
  double mu = pars["mu"] ;
  double sigma = pars["sigma"] ;
  if (x[0] &gt; 0)
    return -log(x[0]) - pow(log(x[0]) - mu, 2.0) / (2.0 * pow(sigma, 2.0)) ;
  else
    return R_NegInf ;
}</code></pre>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ptr_lnorm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_xptr.html">create_xptr</a></span><span class="op">(</span><span class="st">"logdlnorm"</span><span class="op">)</span>
<span class="kw">if</span> <span class="op">(</span><span class="va">got_microbenchmark</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span>
   old <span class="op">=</span> <span class="fu"><a href="../reference/ru.html">ru</a></span><span class="op">(</span>logf <span class="op">=</span> <span class="va">dlnorm</span>, log <span class="op">=</span> <span class="cn">TRUE</span>, d <span class="op">=</span> <span class="fl">1</span>, n <span class="op">=</span> <span class="va">n</span>, lower <span class="op">=</span> <span class="fl">0</span>, init <span class="op">=</span> <span class="fl">0.1</span>,
            trans <span class="op">=</span> <span class="st">"BC"</span>, lambda <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,
   new <span class="op">=</span> <span class="fu"><a href="../reference/ru_rcpp.html">ru_rcpp</a></span><span class="op">(</span>logf <span class="op">=</span> <span class="va">ptr_lnorm</span>, mu <span class="op">=</span> <span class="fl">0</span>, sigma <span class="op">=</span> <span class="fl">1</span>, d <span class="op">=</span> <span class="fl">1</span>, n <span class="op">=</span> <span class="va">n</span>,
                 lower <span class="op">=</span> <span class="fl">0</span>, init <span class="op">=</span> <span class="fl">0.1</span>, trans <span class="op">=</span> <span class="st">"BC"</span>, lambda <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>
  <span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">res</span>, signif <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>
<span class="op">}</span>  
<span class="co">#&gt; Unit: milliseconds</span>
<span class="co">#&gt;  expr    min     lq   mean median     uq    max neval</span>
<span class="co">#&gt;   old 32.750 35.000 38.220  36.97 39.690 55.390   100</span>
<span class="co">#&gt;   new  3.969  4.162  4.798   4.30  4.717  9.863   100</span></code></pre></div>
</div>
<div id="generalized-pareto-posterior-density" class="section level3">
<h3 class="hasAnchor">
<a href="#generalized-pareto-posterior-density" class="anchor"></a>Generalized Pareto posterior density</h3>
<p>The C++ function to calculate the log-posterior density is:</p>
<pre><code>// Generalized Pareto posterior based on an MDI prior truncated to
// shape parameter xi &gt;= -1.

// [[Rcpp::export]]
double loggp(const Rcpp::NumericVector&amp; x, const Rcpp::List&amp; ss) {
  Rcpp::NumericVector gpd_data = ss["gpd_data"] ;
  int m = ss["m"] ;
  double xm = ss["xm"] ;
  double sum_gp = ss["sum_gp"] ;
  if (x[0] &lt;= 0 || x[1] &lt;= -x[0] / xm)
    return R_NegInf ;
  double loglik ;
  Rcpp::NumericVector sdat = gpd_data / x[0] ;
  Rcpp::NumericVector zz = 1 + x[1] * sdat ;
  if (std::abs(x[1]) &gt; 1e-6) {
    loglik = -m * log(x[0]) - (1.0 + 1.0 / x[1]) * sum(log(zz)) ;
  } else {
    double t1, t2, sdatj ;
    double total = 0;
    for(int j = 0; j &lt; m; ++j) {
      sdatj = sdat[j] ;
      for(int i = 1; i &lt; 5; ++i) {
        t1 = pow(sdatj, i) ;
        t2 = (i * sdatj - i - 1) ;
        total += pow(-1.0, i) * t1 * t2 * pow(x[1], i) / i / (i + 1) ;
      }
    }
    loglik = -m * log(x[0]) - sum_gp / x[0] - total ;
  }
  // MDI prior.
  if (x[1] &lt; -1)
    return R_NegInf ;
  double logprior = -log(x[0]) - x[1] - 1 ;
  return (logprior + loglik) ;
}</code></pre>
<p>We simulate some data from a Generalized Pareto distribution, calculate summary statistics involved in the likelihood and calculate an initial value in the search for the posterior mode.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">46</span><span class="op">)</span>
<span class="co"># Sample data from a GP(sigma, xi) distribution</span>
<span class="va">gpd_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rgpd.html">rgpd</a></span><span class="op">(</span>m <span class="op">=</span> <span class="fl">100</span>, xi <span class="op">=</span> <span class="op">-</span><span class="fl">0.5</span>, sigma <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
<span class="co"># Calculate summary statistics for use in the log-likelihood</span>
<span class="va">ss</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/gpd_sum_stats.html">gpd_sum_stats</a></span><span class="op">(</span><span class="va">gpd_data</span><span class="op">)</span>
<span class="co"># Calculate an initial estimate</span>
<span class="va">init</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">gpd_data</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></code></pre></div>
<p>Again we see that <code>ru_rcpp</code> is substantially faster than <code>ru</code>.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Arguments for ru_rcpp</span>
<span class="va">ptr_gp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_xptr.html">create_xptr</a></span><span class="op">(</span><span class="st">"loggp"</span><span class="op">)</span>
<span class="va">for_ru_rcpp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>logf <span class="op">=</span> <span class="va">ptr_gp</span>, init <span class="op">=</span> <span class="va">init</span>, d <span class="op">=</span> <span class="fl">2</span>, n <span class="op">=</span> <span class="va">n</span>,
                 lower <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="op">-</span><span class="cn">Inf</span><span class="op">)</span><span class="op">)</span>, <span class="va">ss</span><span class="op">)</span>

<span class="kw">if</span> <span class="op">(</span><span class="va">got_microbenchmark</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span>
   old <span class="op">=</span> <span class="fu"><a href="../reference/ru.html">ru</a></span><span class="op">(</span>logf <span class="op">=</span> <span class="va">gpd_logpost</span>, ss <span class="op">=</span> <span class="va">ss</span>, d <span class="op">=</span> <span class="fl">2</span>, n <span class="op">=</span> <span class="va">n</span>, init <span class="op">=</span> <span class="va">init</span>,
            lower <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="op">-</span><span class="cn">Inf</span><span class="op">)</span><span class="op">)</span>,
   new <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="va">ru_rcpp</span>, <span class="va">for_ru_rcpp</span><span class="op">)</span>
  <span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">res</span>, signif <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>
<span class="op">}</span>  
<span class="co">#&gt; Unit: milliseconds</span>
<span class="co">#&gt;  expr   min    lq  mean median    uq    max neval</span>
<span class="co">#&gt;   old 86.33 92.83 95.46  94.11 96.35 150.60   100</span>
<span class="co">#&gt;   new 16.89 17.38 18.92  18.08 19.32  29.52   100</span></code></pre></div>
</div>
</div>
<div id="examples-find_lambda_one_d_rcpp-and-find_lambda_rcpp" class="section level2">
<h2 class="hasAnchor">
<a href="#examples-find_lambda_one_d_rcpp-and-find_lambda_rcpp" class="anchor"></a>Examples : <code>find_lambda_one_d_rcpp</code> and <code>find_lambda_rcpp</code>
</h2>
<p>We repeat two examples from the <a href="rust-a-vignette.html">Introducing rust</a> vignette.</p>
<div id="gamma-density-example-for-find_lambda_one_d_rcpp" class="section level3">
<h3 class="hasAnchor">
<a href="#gamma-density-example-for-find_lambda_one_d_rcpp" class="anchor"></a>Gamma density: example for <code>find_lambda_one_d_rcpp</code>
</h3>
<p>We make use of the <a href="http://dirk.eddelbuettel.com/code/rcpp/Rcpp-sugar.pdf">Rcpp sugar</a> function <code>dgamma</code>.</p>
<pre><code>// Gamma(alpha, 1).

// [[Rcpp::export]]
double logdgamma(const Rcpp::NumericVector&amp; x, const Rcpp::List&amp; pars) {
  double shp = pars["alpha"] ;
  return Rcpp::dgamma(x, shp, 1.0, 1)[0] ;
}</code></pre>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">alpha</span> <span class="op">&lt;-</span> <span class="fl">1</span>
<span class="va">max_phi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html">qgamma</a></span><span class="op">(</span><span class="fl">0.999</span>, shape <span class="op">=</span> <span class="va">alpha</span><span class="op">)</span>
<span class="va">ptr_gam</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_xptr.html">create_xptr</a></span><span class="op">(</span><span class="st">"logdgamma"</span><span class="op">)</span>
<span class="va">lambda</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/find_lambda_one_d_rcpp.html">find_lambda_one_d_rcpp</a></span><span class="op">(</span>logf <span class="op">=</span> <span class="va">ptr_gam</span>, alpha <span class="op">=</span> <span class="va">alpha</span>,
                                 max_phi <span class="op">=</span> <span class="va">max_phi</span><span class="op">)</span>
<span class="va">lambda</span>
<span class="co">#&gt; $lambda</span>
<span class="co">#&gt; [1] 0.2727968</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $gm</span>
<span class="co">#&gt; [1] 0.5689906</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $init_psi</span>
<span class="co">#&gt; [1] -0.2016904</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $sd_psi</span>
<span class="co">#&gt; [1] 0.7835109</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $user_args</span>
<span class="co">#&gt; list()</span></code></pre></div>
</div>
<div id="generalized-pareto-posterior-density-example-for-find_lambda_rcpp" class="section level3">
<h3 class="hasAnchor">
<a href="#generalized-pareto-posterior-density-example-for-find_lambda_rcpp" class="anchor"></a>Generalized Pareto posterior density: example for <code>find_lambda_rcpp</code>
</h3>
<p>In this example we supply an external pointer to a C++ function <code>phi_to_theta</code> that ensures that both parameters of the model are strictly positive, a requirement for the Box-Cox transformation to be applicable. The function <code>phi_to_theta</code> must have the same structure as the function used to calculate <span class="math inline">\(\log f\)</span>. See <a href="#cpp_fun">Providing a C++ function to <code>ru_rcpp</code></a> for details. See the <a href="rust-a-vignette.html">Introducing rust</a> vignette for the form of the transformation.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="va">gpd_init</span>, <span class="va">ss</span><span class="op">)</span>
<span class="va">min_phi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmax</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">temp</span><span class="op">$</span><span class="va">init_phi</span> <span class="op">-</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">temp</span><span class="op">$</span><span class="va">se_phi</span><span class="op">)</span>
<span class="va">max_phi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmax</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">temp</span><span class="op">$</span><span class="va">init_phi</span> <span class="op">+</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">temp</span><span class="op">$</span><span class="va">se_phi</span><span class="op">)</span>

<span class="co"># Create external pointers</span>
<span class="va">ptr_gp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_xptr.html">create_xptr</a></span><span class="op">(</span><span class="st">"loggp"</span><span class="op">)</span>
<span class="va">ptr_phi_to_theta_gp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_phi_to_theta_xptr.html">create_phi_to_theta_xptr</a></span><span class="op">(</span><span class="st">"gp"</span><span class="op">)</span>
<span class="co"># Note: log_j is set to zero by default inside find_lambda_rcpp()</span>
<span class="va">lambda</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/find_lambda_rcpp.html">find_lambda_rcpp</a></span><span class="op">(</span>logf <span class="op">=</span> <span class="va">ptr_gp</span>, ss <span class="op">=</span> <span class="va">ss</span>, d <span class="op">=</span> <span class="fl">2</span>, min_phi <span class="op">=</span> <span class="va">min_phi</span>,
                           max_phi <span class="op">=</span> <span class="va">max_phi</span>, user_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>xm <span class="op">=</span> <span class="va">ss</span><span class="op">$</span><span class="va">xm</span><span class="op">)</span>,
                           phi_to_theta <span class="op">=</span> <span class="va">ptr_phi_to_theta_gp</span><span class="op">)</span>
<span class="va">lambda</span>
<span class="co">#&gt; $lambda</span>
<span class="co">#&gt; [1] 0.1624226 0.3678549</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $gm</span>
<span class="co">#&gt; [1] 1.10542493 0.03225836</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $init_psi</span>
<span class="co">#&gt; [1]  0.1054021 -0.2184344</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $sd_psi</span>
<span class="co">#&gt;       Var1       Var2 </span>
<span class="co">#&gt; 0.12670792 0.02477219 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $phi_to_theta</span>
<span class="co">#&gt; &lt;pointer: 0x00000000097192b0&gt;</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $log_j</span>
<span class="co">#&gt; &lt;pointer: 0x00000000097192c0&gt;</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $user_args</span>
<span class="co">#&gt; $user_args$xm</span>
<span class="co">#&gt; [1] 1.846219</span></code></pre></div>
</div>
</div>
<div id="references" class="section level2">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<script type="text/x-mathjax-config">
   MathJax.Hub.Config({  "HTML-CSS": { minScaleAdjust: 125, availableFonts: [] }  });
</script><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-RcppDEbook" class="csl-entry">
Eddelbuettel, D. 2013. <em>Seamless r and c++ Integration with Rcpp</em>. New York: Springer.
</div>
<div id="ref-RcppDE" class="csl-entry">
———. 2016. <em>RcppDE: Global Optimization by Differential Evolution in c++</em>. <a href="https://CRAN.R-project.org/package=RcppDE">https://CRAN.R-project.org/package=RcppDE</a>.
</div>
<div id="ref-Rcpp" class="csl-entry">
Eddelbuettel, D., and R. Francois. 2011. <span>“Rcpp: Seamless r and c++ Integration.”</span> <em>Journal of Statistical Software</em> 40 (8): 1–18. <a href="https://doi.org/10.18637/jss.v040.i08">https://doi.org/10.18637/jss.v040.i08</a>.
</div>
<div id="ref-arma" class="csl-entry">
Eddelbuettel, D., and C. Sanderson. 2014. <span>“RcppArmadillo: Accelerating r with High-Performance c++ Linear Algebra.”</span> <em>Computational Statistics and Data Analysis</em> 71: 1054–63. <a href="https://doi.org/10.1016/j.csda.2013.02.005">https://doi.org/10.1016/j.csda.2013.02.005</a>.
</div>
<div id="ref-microbenchmark" class="csl-entry">
Mersmann, Olaf. 2015. <em>Microbenchmark: Accurate Timing Functions</em>. <a href="https://CRAN.R-project.org/package=microbenchmark">https://CRAN.R-project.org/package=microbenchmark</a>.
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Paul J. Northrop.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
